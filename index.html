<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass Empire</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #0f0f0f; color: white; text-align: center; font-family: 'Segoe UI', sans-serif; user-select: none; }
        .container { margin-top: 50px; }
        #crystal { width: 180px; cursor: pointer; transition: transform 0.05s; }
        #crystal:active { transform: scale(0.95); }
        .score { font-size: 32px; font-weight: bold; margin: 20px 0; color: #00d4ff; }
    </style>
</head>
<body>

    <div class="container">
        <div class="score">üíé <span id="count">0</span></div>
        <img id="crystal" src="https://cdn-icons-png.flaticon.com/512/3209/3209943.png" alt="–ö—Ä–∏—Å—Ç–∞–ª–ª">
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        let crystals = 0;
        // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π ID –∏–≥—Ä–æ–∫–∞ –∏–∑ Telegram
        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id.toString() : 'guest';

        const countElement = document.getElementById('count');

        // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –∏–≥—Ä—É
        async function loadData() {
            try {
                const response = await fetch(`/get-stats?userId=${userId}`);
                const data = await response.json();
                crystals = data.crystals || 0;
                countElement.innerText = crystals;
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
            }
        }

        // 2. –ö–ª–∏–∫ –ø–æ –∫—Ä–∏—Å—Ç–∞–ª–ª—É
        document.getElementById('crystal').onclick = () => {
            crystals++;
            countElement.innerText = crystals;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ 10 –∫–ª–∏–∫–æ–≤, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–µ—Ä
            if (crystals % 10 === 0) {
                saveData();
            }
        };

        // 3. –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function saveData() {
            try {
                await fetch('/save-stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, crystals })
                });
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö");
            }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å, –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        window.addEventListener('beforeunload', saveData);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        loadData();
    </script>
</body>
</html>